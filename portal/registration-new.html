<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>New Registration • Admin</title>

  <link rel="stylesheet" href="../assets/css/portal.css" />

  <script src="../assets/js/env.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../assets/js/supabaseClient.js"></script>
</head>

<body>
  <main class="portal-shell">
    <header class="portal-header">
      <div>
        <h1 class="portal-title">New Registration</h1>
        <p class="portal-subtitle">Add a new student and save the full registration form.</p>
      </div>

      <div class="portal-actions">
        <a class="btn btn-outline" href="./registrations.html">Back</a>
      </div>
    </header>

    <section class="portal-card">
      <form id="regForm" class="form">
        <div class="form-section">
          <h2 class="section-title">Student</h2>

          <div class="form-grid">
            <label class="field">
              <span>Student Full Name <b>*</b></span>
              <input id="studentName" required placeholder="e.g., Devyansh Kumar" />
            </label>

            <label class="field">
              <span>Date of Birth</span>
              <input id="dob" type="date" />
            </label>

            <label class="field">
              <span>Gender</span>
              <select id="gender">
                <option value="">—</option>
                <option>Male</option>
                <option>Female</option>
                <option>Other</option>
              </select>
            </label>

            <label class="field">
              <span>School / Grade</span>
              <input id="schoolGrade" placeholder="e.g., Pre-K / KG / Grade 1" />
            </label>
          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">Parent / Guardian</h2>

          <div class="form-grid">
            <label class="field">
              <span>Parent/Guardian Name <b>*</b></span>
              <input id="parentName" required placeholder="e.g., Rahul Sharma" />
            </label>

            <label class="field">
              <span>Phone <b>*</b></span>
              <input id="parentPhone" required placeholder="+91..." />
            </label>

            <label class="field">
              <span>Email</span>
              <input id="parentEmail" type="email" placeholder="you@email.com" />
            </label>

            <label class="field">
              <span>Alternative Phone</span>
              <input id="altPhone" placeholder="+91..." />
            </label>
          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">Address</h2>

          <div class="form-grid">
            <label class="field form-grid-full">
              <span>Full Address <b>*</b></span>
              <input id="address" required placeholder="House/Street, Area, City, State, PIN" />
            </label>
          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">Program & Notes</h2>

          <div class="form-grid">
            <label class="field">
              <span>Preferred Program</span>
              <input id="preferredProgram" placeholder="e.g., Speech, ABA, Special Education..." />
            </label>

            <label class="field">
              <span>Preferred Days/Time</span>
              <input id="preferredSchedule" placeholder="e.g., Mon/Wed 5–6pm" />
            </label>

            <label class="field form-grid-full">
              <span>Medical / Behaviour Notes</span>
              <textarea id="notes" rows="4" placeholder="Anything important the teachers should know…"></textarea>
            </label>
          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">Student Photo (Mandatory)</h2>

          <div class="form-grid">
            <label class="field form-grid-full">
              <span>Upload Photo <b>*</b></span>
              <input id="photo" type="file" accept="image/*" required />
              <small class="hint">Use a clear face photo. JPG/PNG recommended.</small>
            </label>

            <div class="preview-wrap form-grid-full" id="previewWrap" style="display:none;">
              <img id="previewImg" alt="Student preview" />
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button id="submitBtn" class="btn btn-primary" type="submit">Create Registration</button>
          <p class="muted" id="statusMsg"></p>
        </div>
      </form>
    </section>
  </main>

  <script>
    // ---------- Admin Guard ----------
    async function requireAdmin() {
      const { data: { user } } = await window.sb.auth.getUser();
      if (!user) { window.location.href = "./login.html"; return null; }

      const { data: profile, error } = await window.sb
        .from("profiles")
        .select("role")
        .eq("id", user.id)
        .single();

      if (error || !profile || profile.role !== "admin") {
        alert("Admins only.");
        window.location.href = "./admin-home.html";
        return null;
      }
      return user;
    }

    // ---------- Helpers ----------
    function slugify(name){
      return (name || "student")
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");
    }

    function getFileExt(file){
      const parts = (file.name || "").split(".");
      return parts.length > 1 ? parts.pop().toLowerCase() : "jpg";
    }

    // ---------- Page ----------
    const BUCKET = "student-photos"; // change if your bucket name differs

    const form = document.getElementById("regForm");
    const submitBtn = document.getElementById("submitBtn");
    const statusMsg = document.getElementById("statusMsg");

    const photoInput = document.getElementById("photo");
    const previewWrap = document.getElementById("previewWrap");
    const previewImg = document.getElementById("previewImg");

    photoInput.addEventListener("change", () => {
      const f = photoInput.files?.[0];
      if (!f) { previewWrap.style.display = "none"; return; }
      const url = URL.createObjectURL(f);
      previewImg.src = url;
      previewWrap.style.display = "block";
    });

    (async function init(){
      await requireAdmin();
    })();

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusMsg.textContent = "";

      const user = await requireAdmin();
      if (!user) return;

      submitBtn.disabled = true;
      submitBtn.textContent = "Saving…";

      try {
        // Gather fields
        const studentName = document.getElementById("studentName").value.trim();
        const parentName = document.getElementById("parentName").value.trim();
        const parentPhone = document.getElementById("parentPhone").value.trim();
        const address = document.getElementById("address").value.trim();

        const dob = document.getElementById("dob").value || null;
        const gender = document.getElementById("gender").value || null;
        const schoolGrade = document.getElementById("schoolGrade").value.trim() || null;

        const parentEmail = document.getElementById("parentEmail").value.trim() || null;
        const altPhone = document.getElementById("altPhone").value.trim() || null;

        const preferredProgram = document.getElementById("preferredProgram").value.trim() || null;
        const preferredSchedule = document.getElementById("preferredSchedule").value.trim() || null;
        const notes = document.getElementById("notes").value.trim() || null;

        const file = photoInput.files?.[0];
        if (!file) {
          alert("Student photo is required.");
          return;
        }

        // 1) Create student row first (so we get student_id)
        const { data: studentInsert, error: sErr } = await window.sb
          .from("students")
          .insert([{
            full_name: studentName,
            parent_name: parentName,
            parent_phone: parentPhone,
            address: address,
            is_active: true,
            registration_date: new Date().toISOString().slice(0,10)
          }])
          .select("id")
          .single();

        if (sErr) throw sErr;

        const studentId = studentInsert.id;

        // 2) Upload photo to Storage
        const ext = getFileExt(file);
        const path = `${studentId}/${slugify(studentName)}-${Date.now()}.${ext}`;

        const { error: upErr } = await window.sb
          .storage
          .from(BUCKET)
          .upload(path, file, { upsert: true });

        if (upErr) throw upErr;

        // 3) Get public URL & save into students.photo_url
        const { data: pub } = window.sb.storage.from(BUCKET).getPublicUrl(path);
        const photoUrl = pub?.publicUrl || null;

        if (photoUrl) {
          const { error: pErr } = await window.sb
            .from("students")
            .update({ photo_url: photoUrl })
            .eq("id", studentId);
          if (pErr) throw pErr;
        }

        // 4) Insert full registration snapshot in student_registrations
        const formData = {
          student: { full_name: studentName, dob, gender, school_grade: schoolGrade },
          parent: { name: parentName, phone: parentPhone, email: parentEmail, alt_phone: altPhone },
          address: { full_address: address },
          preferences: { preferred_program: preferredProgram, preferred_schedule: preferredSchedule },
          notes,
          photo_url: photoUrl
        };

        const { error: rErr } = await window.sb
          .from("student_registrations")
          .insert([{
            student_id: studentId,
            form_data: formData,
            created_by: user.id
          }]);

        if (rErr) throw rErr;

        statusMsg.textContent = "✅ Registration created successfully.";
        // Redirect to details page
        window.location.href = `./registration-details.html?student_id=${studentId}`;

      } catch (err) {
        console.error(err);
        alert("Error: " + (err?.message || "Something went wrong"));
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Create Registration";
      }
    });
  </script>
</body>
</html>