<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>New Registration • Admin</title>

  <link rel="stylesheet" href="../assets/css/portal.css" />

  <script src="../assets/js/env.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../assets/js/supabaseClient.js"></script>
  <script src="../assets/js/auth.js"></script>
</head>

<body>
  <main class="portal-shell">
    <header class="portal-header">
      <div>
        <h1 class="portal-title">New Registration</h1>
        <p class="portal-subtitle">Add a new student and save the full registration form.</p>
      </div>

      <div class="portal-actions">
        <a class="btn btn-outline" href="./registrations.html">Back</a>
      </div>
    </header>

    <section class="portal-card">
      <form id="regForm" class="form">

        <!-- I. Basic Contact Information -->
        <div class="form-section">
          <h2 class="section-title">I. Basic Contact Information</h2>
          <div class="form-grid">
            <label class="field">
              <span>Parent’s Name <b>*</b></span>
              <input id="parentName" required />
            </label>

            <label class="field">
              <span>Phone Number <b>*</b></span>
              <input id="parentPhone" required />
            </label>

            <label class="field">
              <span>Contact Email Address</span>
              <input id="parentEmail" type="email" />
            </label>

            <label class="field form-grid-full">
              <span>Address <b>*</b></span>
              <input id="address" required />
            </label>
          </div>
        </div>

        <!-- II. Child’s Profile -->
        <div class="form-section">
          <h2 class="section-title">II. Child’s Profile</h2>
          <div class="form-grid">
            <label class="field">
              <span>Child’s Name <b>*</b></span>
              <input id="studentName" required />
            </label>

            <label class="field">
              <span>Age</span>
              <input id="age" placeholder="e.g., 3" />
            </label>

            <label class="field">
              <span>Date of Birth (DOB)</span>
              <input id="dob" type="date" />
            </label>

            <label class="field">
              <span>Grade</span>
              <input id="grade" placeholder="e.g., Pre-K / KG / Grade 1" />
            </label>

            <label class="field form-grid-full">
              <span>School Name</span>
              <input id="schoolName" />
            </label>
          </div>
        </div>

        <!-- III. Family & Living Situation -->
        <div class="form-section">
          <h2 class="section-title">III. Family & Living Situation</h2>
          <div class="form-grid">
            <label class="field form-grid-full">
              <span>Siblings living in the home (Names/Ages)</span>
              <textarea id="siblingsHome" rows="2"></textarea>
            </label>

            <label class="field form-grid-full">
              <span>Siblings living outside the home</span>
              <textarea id="siblingsOutside" rows="2"></textarea>
            </label>

            <label class="field form-grid-full">
              <span>Primary Language Spoken at Home</span>
              <input id="primaryLanguage" />
            </label>
          </div>
        </div>

        <!-- IV. Medical & Health Background -->
        <div class="form-section">
          <h2 class="section-title">IV. Medical & Health Background</h2>
          <div class="form-grid">
            <label class="field form-grid-full">
              <span>Special Diet / Allergies</span>
              <textarea id="allergies" rows="2"></textarea>
            </label>

            <label class="field form-grid-full">
              <span>Current Medications</span>
              <textarea id="medications" rows="2"></textarea>
            </label>

            <label class="field form-grid-full">
              <span>Primary Care Physician/Pediatrician</span>
              <input id="physician" />
            </label>

            <label class="field form-grid-full">
              <span>Known diagnoses (Medical/Behavioral)?</span>
              <textarea id="diagnoses" rows="3"></textarea>
            </label>
          </div>
        </div>

        <!-- V. Emergency Contact -->
        <div class="form-section">
          <h2 class="section-title">V. Emergency Contact (Other than Parent)</h2>
          <div class="form-grid">
            <label class="field">
              <span>Name</span>
              <input id="emergencyName" />
            </label>

            <label class="field">
              <span>Relationship</span>
              <input id="emergencyRelationship" />
            </label>

            <label class="field">
              <span>Phone</span>
              <input id="emergencyPhone" />
            </label>
          </div>
        </div>

        <!-- VI. Developmental Milestones / Concerns -->
        <div class="form-section">
          <h2 class="section-title">VI. Developmental Milestones / Concerns</h2>
          <div class="form-grid">
            <label class="field form-grid-full">
              <span>Concerns (speech, motor skills, social interaction)</span>
              <textarea id="devConcerns" rows="3"></textarea>
            </label>

            <label class="field form-grid-full">
              <span>Strengths & Interests</span>
              <textarea id="strengths" rows="2"></textarea>
            </label>

            <label class="field form-grid-full">
              <span>What does the child enjoy or excel at?</span>
              <textarea id="enjoys" rows="2"></textarea>
            </label>

            <label class="field form-grid-full">
              <span>Goals for Seeking Services</span>
              <textarea id="goals" rows="3"></textarea>
            </label>
          </div>
        </div>

        <!-- VII. Referral Source -->
        <div class="form-section">
          <h2 class="section-title">VII. Referral Source</h2>
          <div class="form-grid">
            <label class="field form-grid-full">
              <span>How did you hear about us?</span>
              <input id="referralSource" />
            </label>
          </div>
        </div>

        <!-- Student Photo -->
        <div class="form-section">
          <h2 class="section-title">Student Photo (Mandatory)</h2>
          <div class="form-grid">
            <label class="field form-grid-full">
              <span>Upload Photo <b>*</b></span>
              <input id="photo" type="file" accept="image/*" required />
              <small class="hint">Use a clear face photo. JPG/PNG recommended.</small>
            </label>

            <div class="preview-wrap form-grid-full" id="previewWrap" style="display:none;">
              <img id="previewImg" alt="Student preview" />
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button id="submitBtn" class="btn btn-primary" type="submit">Create Registration</button>
          <p class="muted" id="statusMsg"></p>
        </div>
      </form>
    </section>
  </main>

  <script>
    // Uses the same guard pattern as rest of portal (auth.js)
    async function requireAdminOrExit() {
      const user = await requireAuth();
      if (!user) return null;

      const profile = await getMyProfile();
      if (profile?.role !== "admin") {
        alert("Admins only.");
        window.location.href = "./admin-home.html";
        return null;
      }
      return user;
    }

    function slugify(name){
      return (name || "student")
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "");
    }

    function getFileExt(file){
      const parts = (file.name || "").split(".");
      return parts.length > 1 ? parts.pop().toLowerCase() : "jpg";
    }

    const BUCKET = "student-photos"; // change if your bucket differs

    const form = document.getElementById("regForm");
    const submitBtn = document.getElementById("submitBtn");
    const statusMsg = document.getElementById("statusMsg");

    const photoInput = document.getElementById("photo");
    const previewWrap = document.getElementById("previewWrap");
    const previewImg = document.getElementById("previewImg");

    photoInput.addEventListener("change", () => {
      const f = photoInput.files?.[0];
      if (!f) { previewWrap.style.display = "none"; return; }
      previewImg.src = URL.createObjectURL(f);
      previewWrap.style.display = "block";
    });

    (async function init(){
      await requireAdminOrExit();
    })();

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusMsg.textContent = "";

      const user = await requireAdminOrExit();
      if (!user) return;

      submitBtn.disabled = true;
      submitBtn.textContent = "Saving…";

      try {
        // Basic contact
        const parentName = document.getElementById("parentName").value.trim();
        const parentPhone = document.getElementById("parentPhone").value.trim();
        const parentEmail = document.getElementById("parentEmail").value.trim() || null;
        const address = document.getElementById("address").value.trim();

        // Child
        const studentName = document.getElementById("studentName").value.trim();
        const age = document.getElementById("age").value.trim() || null;
        const dob = document.getElementById("dob").value || null;
        const grade = document.getElementById("grade").value.trim() || null;
        const schoolName = document.getElementById("schoolName").value.trim() || null;

        // Family
        const siblingsHome = document.getElementById("siblingsHome").value.trim() || null;
        const siblingsOutside = document.getElementById("siblingsOutside").value.trim() || null;
        const primaryLanguage = document.getElementById("primaryLanguage").value.trim() || null;

        // Medical
        const allergies = document.getElementById("allergies").value.trim() || null;
        const medications = document.getElementById("medications").value.trim() || null;
        const physician = document.getElementById("physician").value.trim() || null;
        const diagnoses = document.getElementById("diagnoses").value.trim() || null;

        // Emergency
        const emergencyName = document.getElementById("emergencyName").value.trim() || null;
        const emergencyRelationship = document.getElementById("emergencyRelationship").value.trim() || null;
        const emergencyPhone = document.getElementById("emergencyPhone").value.trim() || null;

        // Developmental
        const devConcerns = document.getElementById("devConcerns").value.trim() || null;
        const strengths = document.getElementById("strengths").value.trim() || null;
        const enjoys = document.getElementById("enjoys").value.trim() || null;
        const goals = document.getElementById("goals").value.trim() || null;

        // Referral
        const referralSource = document.getElementById("referralSource").value.trim() || null;

        const file = photoInput.files?.[0];
        if (!file) { alert("Student photo is required."); return; }

        // 1) Insert into students (core data for scheduling)
        const { data: studentInsert, error: sErr } = await window.sb
          .from("students")
          .insert([{
            full_name: studentName,
            parent_name: parentName,
            parent_phone: parentPhone,
            parent_email: parentEmail,
            address: address,
            dob: dob,
            age: age,
            grade: grade,
            school_name: schoolName,
            is_active: true,
            registration_date: new Date().toISOString().slice(0,10)
          }])
          .select("id")
          .single();

        if (sErr) throw sErr;

        const studentId = studentInsert.id;

        // 2) Upload photo
        const ext = getFileExt(file);
        const path = `${studentId}/${slugify(studentName)}-${Date.now()}.${ext}`;

        const { error: upErr } = await window.sb.storage.from(BUCKET).upload(path, file, { upsert: true });
        if (upErr) throw upErr;

        // 3) Save photo_url
        const { data: pub } = window.sb.storage.from(BUCKET).getPublicUrl(path);
        const photoUrl = pub?.publicUrl || null;

        if (photoUrl) {
          const { error: pErr } = await window.sb.from("students")
            .update({ photo_url: photoUrl })
            .eq("id", studentId);
          if (pErr) throw pErr;
        }

        // 4) Save the full registration snapshot JSON
        const formData = {
          basic_contact: { parent_name: parentName, address, email: parentEmail, phone: parentPhone },
          child_profile: { child_name: studentName, age, dob, grade, school_name: schoolName },
          family_living: { siblings_home: siblingsHome, siblings_outside: siblingsOutside, primary_language: primaryLanguage },
          medical_health: { allergies, medications, physician, diagnoses },
          emergency_contact: { name: emergencyName, relationship: emergencyRelationship, phone: emergencyPhone },
          developmental: { concerns: devConcerns, strengths, enjoys, goals },
          referral: { source: referralSource },
          office_use: { date_of_intake: new Date().toISOString().slice(0,10), staff_member: null },
          photo_url: photoUrl
        };

        const { error: rErr } = await window.sb
          .from("student_registrations")
          .insert([{
            student_id: studentId,
            form_data: formData,
            created_by: user.id
          }]);

        if (rErr) throw rErr;

        statusMsg.textContent = "✅ Registration created successfully.";
        window.location.href = `./registration-details.html?student_id=${studentId}`;

      } catch (err) {
        console.error(err);
        alert("Error: " + (err?.message || "Something went wrong"));
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Create Registration";
      }
    });
  </script>
</body>
</html>