<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registration Details • Admin</title>

  <link rel="stylesheet" href="../assets/css/portal.css" />

  <script src="../assets/js/env.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../assets/js/supabaseClient.js"></script>

  <style>
    /* Print-only formatting */
    @media print {
      header, .portal-actions, .no-print { display: none !important; }
      body { background: #fff !important; }
      .portal-card { box-shadow: none !important; border: none !important; }
      .section-card { break-inside: avoid; }
    }

    .detail-grid{
      display:grid;
      grid-template-columns: 1fr 280px;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 900px){
      .detail-grid{ grid-template-columns: 1fr; }
    }

    .photo-card{
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 16px;
      overflow:hidden;
      background:#fff;
    }
    .photo-card img{
      width:100%;
      height: 280px;
      object-fit: cover;
      display:block;
      background:#f3f4f6;
    }

    .section-card{
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 16px;
      padding: 14px;
      background:#fff;
      margin: 0 0 12px;
    }
    .section-title{
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: 800;
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .kv .row{
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 14px;
      padding: 10px 12px;
      background:#fff;
    }
    .kv .row strong{
      display:block;
      font-size: 12px;
      opacity: .8;
      margin-bottom: 4px;
    }
    .kv .row span{
      display:block;
      font-weight: 600;
      word-break: break-word;
    }
    .kv .row.full{ grid-column: 1 / -1; }

    .muted{ opacity: .75; }

    .field span{ display:block; margin-bottom: 6px; font-weight: 600; }
    .field input, .field textarea, .field select{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.14);
      background:#fff;
      font: inherit;
    }
    .form-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .form-grid-full{ grid-column: 1 / -1; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.14);
      background:#fff;
      font-weight:700;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <main class="portal-shell">
    <header class="portal-header">
      <div>
        <h1 class="portal-title">Registration Details</h1>
        <p class="portal-subtitle">View, print, or edit student registration information.</p>
      </div>

      <div class="portal-actions no-print">
        <a class="btn btn-outline" href="./registrations.html">Back</a>
        <button class="btn btn-outline" id="printBtn" type="button">Print</button>
        <button class="btn btn-primary" id="editBtn" type="button">Edit JSON</button>
        <button class="btn btn-primary" id="saveBtn" type="button" style="display:none;">Save</button>
        <button class="btn btn-outline" id="cancelBtn" type="button" style="display:none;">Cancel</button>
      </div>
    </header>

    <section class="portal-card">
      <div id="loading" class="muted">Loading…</div>

      <div id="content" style="display:none;">
        <div class="detail-grid">

          <!-- LEFT -->
          <div>
            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;">
              <h2 id="studentTitle" style="margin:0;"></h2>
              <span class="pill" id="activePill"></span>
            </div>

            <!-- READ VIEW -->
            <div id="readView">

              <div class="section-card">
                <div class="section-title">Core Details</div>
                <div class="kv">
                  <div class="row">
                    <strong>Parent</strong>
                    <span id="rvParent">—</span>
                  </div>
                  <div class="row">
                    <strong>Phone</strong>
                    <span id="rvPhone">—</span>
                  </div>
                  <div class="row full">
                    <strong>Address</strong>
                    <span id="rvAddress">—</span>
                  </div>
                  <div class="row">
                    <strong>Registration Date</strong>
                    <span id="rvRegDate">—</span>
                  </div>
                  <div class="row">
                    <strong>Active</strong>
                    <span id="rvActive">—</span>
                  </div>
                </div>
              </div>

              <div class="section-card" id="secBasic">
                <div class="section-title">I. Basic Contact Information</div>
                <div class="kv">
                  <div class="row">
                    <strong>Parent’s Name</strong>
                    <span id="fParentName">—</span>
                  </div>
                  <div class="row">
                    <strong>Phone</strong>
                    <span id="fParentPhone">—</span>
                  </div>
                  <div class="row">
                    <strong>Email</strong>
                    <span id="fParentEmail">—</span>
                  </div>
                  <div class="row full">
                    <strong>Address</strong>
                    <span id="fAddress">—</span>
                  </div>
                </div>
              </div>

              <div class="section-card" id="secChild">
                <div class="section-title">II. Child’s Profile</div>
                <div class="kv">
                  <div class="row">
                    <strong>Child’s Name</strong>
                    <span id="fChildName">—</span>
                  </div>
                  <div class="row">
                    <strong>Age</strong>
                    <span id="fAge">—</span>
                  </div>
                  <div class="row">
                    <strong>DOB</strong>
                    <span id="fDob">—</span>
                  </div>
                  <div class="row">
                    <strong>Grade</strong>
                    <span id="fGrade">—</span>
                  </div>
                  <div class="row full">
                    <strong>School Name</strong>
                    <span id="fSchool">—</span>
                  </div>
                </div>
              </div>

              <div class="section-card" id="secFamily">
                <div class="section-title">III. Family & Living Situation</div>
                <div class="kv">
                  <div class="row full">
                    <strong>Siblings living in the home</strong>
                    <span id="fSiblingsHome">—</span>
                  </div>
                  <div class="row full">
                    <strong>Siblings living outside the home</strong>
                    <span id="fSiblingsOutside">—</span>
                  </div>
                  <div class="row full">
                    <strong>Primary Language</strong>
                    <span id="fLanguage">—</span>
                  </div>
                </div>
              </div>

              <div class="section-card" id="secMedical">
                <div class="section-title">IV. Medical & Health Background</div>
                <div class="kv">
                  <div class="row full">
                    <strong>Special Diet / Allergies</strong>
                    <span id="fAllergies">—</span>
                  </div>
                  <div class="row full">
                    <strong>Current Medications</strong>
                    <span id="fMeds">—</span>
                  </div>
                  <div class="row full">
                    <strong>Physician/Pediatrician</strong>
                    <span id="fPhysician">—</span>
                  </div>
                  <div class="row full">
                    <strong>Known diagnoses</strong>
                    <span id="fDiagnoses">—</span>
                  </div>
                </div>
              </div>

              <div class="section-card" id="secEmergency">
                <div class="section-title">V. Emergency Contact</div>
                <div class="kv">
                  <div class="row">
                    <strong>Name</strong>
                    <span id="fEName">—</span>
                  </div>
                  <div class="row">
                    <strong>Relationship</strong>
                    <span id="fERel">—</span>
                  </div>
                  <div class="row full">
                    <strong>Phone</strong>
                    <span id="fEPhone">—</span>
                  </div>
                </div>
              </div>

              <div class="section-card" id="secDev">
                <div class="section-title">VI. Developmental Milestones / Concerns</div>
                <div class="kv">
                  <div class="row full">
                    <strong>Concerns</strong>
                    <span id="fConcerns">—</span>
                  </div>
                  <div class="row full">
                    <strong>Strengths & Interests</strong>
                    <span id="fStrengths">—</span>
                  </div>
                  <div class="row full">
                    <strong>Enjoys / Excels at</strong>
                    <span id="fEnjoys">—</span>
                  </div>
                  <div class="row full">
                    <strong>Goals</strong>
                    <span id="fGoals">—</span>
                  </div>
                </div>
              </div>

              <div class="section-card" id="secReferral">
                <div class="section-title">VII. Referral Source</div>
                <div class="kv">
                  <div class="row full">
                    <strong>How did you hear about us?</strong>
                    <span id="fReferral">—</span>
                  </div>
                </div>
              </div>

              <div class="section-card" id="secOffice">
                <div class="section-title">Office Use</div>
                <div class="kv">
                  <div class="row">
                    <strong>Date of Intake</strong>
                    <span id="fIntakeDate">—</span>
                  </div>
                  <div class="row">
                    <strong>Staff Member</strong>
                    <span id="fStaff">—</span>
                  </div>
                </div>
              </div>

              <div class="section-card">
                <div class="section-title">Raw Form JSON (for reference)</div>
                <pre id="rvFormJson" style="white-space:pre-wrap; margin:0;"></pre>
              </div>

            </div>

            <!-- EDIT (JSON) -->
            <div id="editView" style="display:none;">
              <h3 style="margin: 4px 0 10px;">Edit Details</h3>

              <div class="form-grid">
                <label class="field">
                  <span>Student Full Name</span>
                  <input id="evStudentName" />
                </label>

                <label class="field">
                  <span>Registration Date</span>
                  <input id="evRegDate" type="date" />
                </label>

                <label class="field">
                  <span>Parent Name</span>
                  <input id="evParentName" />
                </label>

                <label class="field">
                  <span>Parent Phone</span>
                  <input id="evParentPhone" />
                </label>

                <label class="field form-grid-full">
                  <span>Address</span>
                  <input id="evAddress" />
                </label>

                <label class="field">
                  <span>Active</span>
                  <select id="evActive">
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                  </select>
                </label>

                <label class="field form-grid-full">
                  <span>Registration Form Data (JSON)</span>
                  <textarea id="evFormJson" rows="16"></textarea>
                  <small class="muted">This stores the full form snapshot. Keep it valid JSON.</small>
                </label>
              </div>
            </div>

          </div>

          <!-- RIGHT -->
          <aside>
            <div class="photo-card">
              <img id="photoImg" alt="Student photo" />
            </div>

            <div class="section-card" style="margin-top:12px;">
              <div class="section-title">Photo URL</div>
              <div class="muted" id="photoUrlText">—</div>
            </div>
          </aside>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ---------- Admin Guard ----------
    async function requireAdmin() {
      const { data: { user } } = await window.sb.auth.getUser();
      if (!user) { window.location.href = "./login.html"; return null; }

      const { data: profile, error } = await window.sb
        .from("profiles")
        .select("role")
        .eq("id", user.id)
        .single();

      if (error || !profile || profile.role !== "admin") {
        alert("Admins only.");
        window.location.href = "./admin-home.html";
        return null;
      }
      return user;
    }

    function qp(name){
      const u = new URL(window.location.href);
      return u.searchParams.get(name);
    }

    function safeStringify(obj){
      try { return JSON.stringify(obj, null, 2); }
      catch { return "{}"; }
    }

    function fmt(val){
      if (val === null || val === undefined) return "—";
      const s = String(val).trim();
      return s ? s : "—";
    }

    function fmtDate(val){
      if (!val) return "—";
      try { return new Date(val).toLocaleDateString(); }
      catch { return fmt(val); }
    }

    const studentId = qp("student_id");

    const loading = document.getElementById("loading");
    const content = document.getElementById("content");

    const studentTitle = document.getElementById("studentTitle");
    const activePill = document.getElementById("activePill");

    // Core view
    const rvParent = document.getElementById("rvParent");
    const rvPhone = document.getElementById("rvPhone");
    const rvAddress = document.getElementById("rvAddress");
    const rvRegDate = document.getElementById("rvRegDate");
    const rvActive = document.getElementById("rvActive");
    const rvFormJson = document.getElementById("rvFormJson");

    // Photo
    const photoImg = document.getElementById("photoImg");
    const photoUrlText = document.getElementById("photoUrlText");

    // Read fields (from form_data)
    const fParentName = document.getElementById("fParentName");
    const fParentPhone = document.getElementById("fParentPhone");
    const fParentEmail = document.getElementById("fParentEmail");
    const fAddress = document.getElementById("fAddress");

    const fChildName = document.getElementById("fChildName");
    const fAge = document.getElementById("fAge");
    const fDob = document.getElementById("fDob");
    const fGrade = document.getElementById("fGrade");
    const fSchool = document.getElementById("fSchool");

    const fSiblingsHome = document.getElementById("fSiblingsHome");
    const fSiblingsOutside = document.getElementById("fSiblingsOutside");
    const fLanguage = document.getElementById("fLanguage");

    const fAllergies = document.getElementById("fAllergies");
    const fMeds = document.getElementById("fMeds");
    const fPhysician = document.getElementById("fPhysician");
    const fDiagnoses = document.getElementById("fDiagnoses");

    const fEName = document.getElementById("fEName");
    const fERel = document.getElementById("fERel");
    const fEPhone = document.getElementById("fEPhone");

    const fConcerns = document.getElementById("fConcerns");
    const fStrengths = document.getElementById("fStrengths");
    const fEnjoys = document.getElementById("fEnjoys");
    const fGoals = document.getElementById("fGoals");

    const fReferral = document.getElementById("fReferral");

    const fIntakeDate = document.getElementById("fIntakeDate");
    const fStaff = document.getElementById("fStaff");

    // Edit controls
    const readView = document.getElementById("readView");
    const editView = document.getElementById("editView");
    const editBtn = document.getElementById("editBtn");
    const saveBtn = document.getElementById("saveBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const printBtn = document.getElementById("printBtn");

    const evStudentName = document.getElementById("evStudentName");
    const evParentName = document.getElementById("evParentName");
    const evParentPhone = document.getElementById("evParentPhone");
    const evAddress = document.getElementById("evAddress");
    const evRegDate = document.getElementById("evRegDate");
    const evActive = document.getElementById("evActive");
    const evFormJson = document.getElementById("evFormJson");

    let studentRow = null;
    let regRow = null;

    printBtn.addEventListener("click", () => window.print());

    function setMode(mode){
      const isEdit = mode === "edit";
      readView.style.display = isEdit ? "none" : "block";
      editView.style.display = isEdit ? "block" : "none";
      editBtn.style.display = isEdit ? "none" : "inline-flex";
      saveBtn.style.display = isEdit ? "inline-flex" : "none";
      cancelBtn.style.display = isEdit ? "inline-flex" : "none";
    }

    cancelBtn.addEventListener("click", () => {
      fillEditFields();
      setMode("read");
    });

    editBtn.addEventListener("click", () => {
      fillEditFields();
      setMode("edit");
    });

    function fillEditFields(){
      evStudentName.value = studentRow?.full_name || "";
      evParentName.value = studentRow?.parent_name || "";
      evParentPhone.value = studentRow?.parent_phone || "";
      evAddress.value = studentRow?.address || "";
      evRegDate.value = studentRow?.registration_date || "";
      evActive.value = String(!!studentRow?.is_active);
      evFormJson.value = safeStringify(regRow?.form_data || {});
    }

    function fillReadView(){
      studentTitle.textContent = studentRow?.full_name || "Student";

      const isActive = !!studentRow?.is_active;
      activePill.textContent = isActive ? "Active" : "Inactive";

      rvParent.textContent = fmt(studentRow?.parent_name);
      rvPhone.textContent = fmt(studentRow?.parent_phone);
      rvAddress.textContent = fmt(studentRow?.address);
      rvRegDate.textContent = studentRow?.registration_date ? fmtDate(studentRow.registration_date) : "—";
      rvActive.textContent = isActive ? "Active" : "Inactive";

      const form = regRow?.form_data || {};

      // From JSON (new form structure)
      const basic = form.basic_contact || {};
      const child = form.child_profile || {};
      const family = form.family_living || {};
      const med = form.medical_health || {};
      const em = form.emergency_contact || {};
      const dev = form.developmental || {};
      const ref = form.referral || {};
      const office = form.office_use || {};

      fParentName.textContent = fmt(basic.parent_name || studentRow?.parent_name);
      fParentPhone.textContent = fmt(basic.phone || studentRow?.parent_phone);
      fParentEmail.textContent = fmt(basic.email);
      fAddress.textContent = fmt(basic.address || studentRow?.address);

      fChildName.textContent = fmt(child.child_name || studentRow?.full_name);
      fAge.textContent = fmt(child.age);
      fDob.textContent = child.dob ? fmtDate(child.dob) : "—";
      fGrade.textContent = fmt(child.grade);
      fSchool.textContent = fmt(child.school_name);

      fSiblingsHome.textContent = fmt(family.siblings_home);
      fSiblingsOutside.textContent = fmt(family.siblings_outside);
      fLanguage.textContent = fmt(family.primary_language);

      fAllergies.textContent = fmt(med.allergies);
      fMeds.textContent = fmt(med.medications);
      fPhysician.textContent = fmt(med.physician);
      fDiagnoses.textContent = fmt(med.diagnoses);

      fEName.textContent = fmt(em.name);
      fERel.textContent = fmt(em.relationship);
      fEPhone.textContent = fmt(em.phone);

      fConcerns.textContent = fmt(dev.concerns);
      fStrengths.textContent = fmt(dev.strengths);
      fEnjoys.textContent = fmt(dev.enjoys);
      fGoals.textContent = fmt(dev.goals);

      fReferral.textContent = fmt(ref.source);

      fIntakeDate.textContent = office.date_of_intake ? fmtDate(office.date_of_intake) : "—";
      fStaff.textContent = fmt(office.staff_member);

      rvFormJson.textContent = safeStringify(form);

      // Photo
      const photoUrl = studentRow?.photo_url || form?.photo_url || "";
      photoUrlText.textContent = photoUrl || "—";

      if (photoUrl) {
        photoImg.src = photoUrl;
      } else {
        photoImg.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='600'%3E%3Crect width='100%25' height='100%25' fill='%23f3f4f6'/%3E%3Ctext x='50%25' y='50%25' font-size='28' fill='%239ca3af' text-anchor='middle' dominant-baseline='middle'%3ENo Photo%3C/text%3E%3C/svg%3E";
      }
    }

    saveBtn.addEventListener("click", async () => {
      saveBtn.disabled = true;
      saveBtn.textContent = "Saving…";

      try {
        // Validate JSON
        let parsed = {};
        try {
          parsed = JSON.parse(evFormJson.value || "{}");
        } catch (e) {
          alert("Registration JSON is invalid. Please fix it.");
          return;
        }

        // Update students (core fields)
        const { error: uErr } = await window.sb
          .from("students")
          .update({
            full_name: evStudentName.value.trim(),
            parent_name: evParentName.value.trim(),
            parent_phone: evParentPhone.value.trim(),
            address: evAddress.value.trim(),
            registration_date: evRegDate.value || null,
            is_active: evActive.value === "true"
          })
          .eq("id", studentId);

        if (uErr) throw uErr;

        // Upsert registration snapshot
        if (regRow?.id) {
          const { error: rErr } = await window.sb
            .from("student_registrations")
            .update({ form_data: parsed })
            .eq("id", regRow.id);
          if (rErr) throw rErr;
        } else {
          const user = await requireAdmin();
          const { error: rInsErr } = await window.sb
            .from("student_registrations")
            .insert([{
              student_id: studentId,
              form_data: parsed,
              created_by: user?.id || null
            }]);
          if (rInsErr) throw rInsErr;
        }

        await loadData();
        setMode("read");
        alert("Saved.");

      } catch (err) {
        console.error(err);
        alert("Error: " + (err?.message || "Something went wrong"));
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = "Save";
      }
    });

    async function loadData(){
      loading.style.display = "block";
      content.style.display = "none";

      const { data: sData, error: sErr } = await window.sb
        .from("students")
        .select("id, full_name, parent_name, parent_phone, address, registration_date, is_active, photo_url")
        .eq("id", studentId)
        .single();

      if (sErr) throw sErr;
      studentRow = sData;

      const { data: rData, error: rErr } = await window.sb
        .from("student_registrations")
        .select("id, student_id, form_data, created_at")
        .eq("student_id", studentId)
        .order("created_at", { ascending: false })
        .limit(1);

      if (rErr) throw rErr;
      regRow = (rData && rData.length) ? rData[0] : null;

      fillReadView();

      loading.style.display = "none";
      content.style.display = "block";
    }

    (async function init(){
      await requireAdmin();
      if (!studentId) {
        alert("Missing student_id");
        window.location.href = "./registrations.html";
        return;
      }
      try {
        await loadData();
        setMode("read");
      } catch (err) {
        console.error(err);
        alert("Error: " + (err?.message || "Unable to load details"));
        window.location.href = "./registrations.html";
      }
    })();
  </script>
</body>
</html>